version: 2.1
jobs:
  build:
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout
      - run:
          name: Pretty print parts of CIRCLE_OIDC_TOKEN_V2
          command: |
            python -c "\
            import os, base64, json;\
            id_token = os.environ['CIRCLE_OIDC_TOKEN_V2']
            parts = id_token.split('.');\
            header = json.loads(base64.urlsafe_b64decode(parts[0].ljust((len(parts[0]) + 3) // 4 * 4, '=')));\
            payload = json.loads(base64.urlsafe_b64decode(parts[1].ljust((len(parts[1]) + 3) // 4 * 4, '=')));\
            print(f'JWT: {id_token[:-1]} ... {id_token[-1]}')
            print(f'Header: {json.dumps(header, indent=4)}');\
            print(f'Payload: {json.dumps(payload, indent=4)}');\
            "

# curl --request PATCH \
#   --url https://circleci.com/api/v2/org/fa00cb57-8b24-435e-8ca9-c2a9f062e7da/project/d601e35f-dc8a-48f9-a8c2-5e28b5bd172f/oidc-custom-claims \
#   --header 'Circle-Token: XXXXXXXXXXX' \
#   --header 'content-type: application/json' \
#   --data '{"audience":["sigstore"]}'
# {"org_id":"fa00cb57-8b24-435e-8ca9-c2a9f062e7da","project_id":"d601e35f-dc8a-48f9-a8c2-5e28b5bd172f","audience":["sigstore"],"audience_updated_at":"2023-06-19T18:06:43.653662Z"}%
